<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Asistencia y Comedor</title>
  <link rel="stylesheet" href="styles.css">
  <!-- SheetJS para leer archivos Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è Comedor CET N¬∞1 General Roca</h1>
      <p style="margin: 8px 0 0 0; font-size: 16px; opacity: 0.95;">Sistema de Gesti√≥n de Inscripciones</p>
    </div>
    
    <div class="content">
      <!-- LOGIN -->
      <div id="login">
        <div class="card" style="text-align: center;">
          <div class="logo-container">
            <img src="logo-colegio.png" alt="Logo CET N¬∞1 General Roca" class="logo-principal" onerror="this.style.display='none'">
          </div>
          <h2 style="margin-top: 20px; color: var(--primary);">¬°Bienvenido/a al Comedor!</h2>
          <p style="color: #666; font-size: 15px; margin-bottom: 20px; font-weight: 500;">üçΩÔ∏è CET N¬∞1 General Roca - Sistema de Gesti√≥n del Comedor Escolar</p>
          <div class="form-group">
            <input type="text" id="usuario" placeholder="Usuario">
          </div>
          <div class="form-group">
            <input type="password" id="contrase√±a" placeholder="Contrase√±a">
          </div>
          <button class="btn-primary" onclick="login()">Entrar</button>
        </div>
      </div>

      <!-- MEN√ö ADMIN -->
      <div id="menuAdmin" class="oculto">
        <div class="card">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <img src="logo-colegio.png" alt="Logo CET N¬∞1" class="logo-menu" onerror="this.style.display='none'">
            <div style="flex: 1;">
              <h2 style="margin: 0;">üéì Panel Administrativo</h2>
              <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Gesti√≥n del Comedor CET N¬∞1</p>
            </div>
          </div>
          
          <div class="button-group">
            <button class="btn-primary" onclick="toggleFormularioRegistro()">
              <span id="btnTextoRegistro">‚ûï Registrar Alumno</span>
            </button>
            <button class="btn-success" onclick="toggleImportarExcel()">
              <span id="btnTextoExcel">üìä Importar desde Excel</span>
            </button>
          </div>
          
          <div id="formularioImportarExcel" class="oculto" style="margin-top: 20px;">
            <h3>Importar Alumnos desde Excel</h3>
            <div class="form-group">
              <input type="file" id="archivoExcel" accept=".xlsx,.xls" onchange="procesarArchivoExcel(event)">
              <small style="color: #666;">Seleccione el archivo Excel con los datos de los alumnos</small>
            </div>
            <div id="vistaPreviaExcel" class="oculto" style="margin-top: 15px;">
              <h4>Vista Previa de Datos:</h4>
              <div id="tablaPreviewExcel" style="overflow-x: auto; max-height: 300px; margin: 10px 0;"></div>
              <div class="button-group">
                <button class="btn-success" onclick="importarAlumnosDesdeExcel()">‚úì Importar Alumnos</button>
                <button class="btn-secondary" onclick="cancelarImportacionExcel()">‚úï Cancelar</button>
              </div>
            </div>
          </div>
          
          <div id="formularioRegistro" class="oculto" style="margin-top: 20px;">
          <h3>Registrar Alumno</h3>
          <div class="form-group">
            <input type="text" id="nombreAlumno" placeholder="Nombre completo">
          </div>
          <div class="form-group">
            <input type="text" id="usuarioAlumno" placeholder="Usuario">
          </div>
          <div class="form-group">
            <input type="password" id="contrase√±aAlumno" placeholder="Contrase√±a">
          </div>
          <div class="form-group">
              <input type="email" id="emailTutores" placeholder="Email de padres/tutores">
            </div>
            <div class="form-group">
              <label for="cicloAlumno">Ciclo:</label>
              <select id="cicloAlumno" onchange="actualizarCursos()">
                <option value="">Seleccionar ciclo...</option>
                <option value="CB">Ciclo B√°sico (CB)</option>
                <option value="CS">Ciclo Superior (CS)</option>
              </select>
            </div>
            <div class="form-group" id="cursoGroup" style="display: none;">
              <label for="cursoAlumno">Curso:</label>
              <select id="cursoAlumno" onchange="actualizarOrientacionYDivisiones()">
                <option value="">Seleccionar curso...</option>
              </select>
            </div>
            <div class="form-group" id="orientacionGroup" style="display: none;">
              <label for="orientacionAlumno">Orientaci√≥n:</label>
              <select id="orientacionAlumno" onchange="actualizarDivisiones()">
                <option value="">Seleccionar orientaci√≥n...</option>
              </select>
            </div>
            <div class="form-group" id="divisionGroup" style="display: none;">
              <label for="divisionAlumno">Divisi√≥n:</label>
              <select id="divisionAlumno">
                <option value="">Seleccionar divisi√≥n...</option>
              </select>
            </div>
            <div class="button-group">
              <button class="btn-success" onclick="registrarAlumno()">‚úì Guardar Alumno</button>
              <button class="btn-secondary" onclick="toggleFormularioRegistro()">‚úï Cancelar</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Men√∫ del D√≠a</h3>
          <div class="form-group">
            <input type="text" id="menuDelDia" placeholder="Ej: Pollo con papas y ensalada">
          </div>
          <button class="btn-success" onclick="establecerMenuDelDia()">Establecer Men√∫</button>
          
          <div id="infoMenuDelDia" class="menu-del-dia oculto">
            <h4>Men√∫ establecido para hoy:</h4>
            <p id="textoMenuDelDia"></p>
          </div>
        </div>

        <div class="card">
          <h3>‚è∞ Configuraci√≥n de Horarios</h3>
          <div class="form-group">
            <label for="horaLimiteInscripcion">Hora l√≠mite para inscribirse:</label>
            <input type="time" id="horaLimiteInscripcion">
            <small style="color: #666;">Los alumnos podr√°n inscribirse hasta esta hora</small>
          </div>
          <div class="form-group">
            <label for="horaLimiteCancelacion">Hora l√≠mite para cancelar (arrepentirse):</label>
            <input type="time" id="horaLimiteCancelacion">
            <small style="color: #666;">Los alumnos podr√°n cancelar su inscripci√≥n hasta esta hora</small>
          </div>
          <button class="btn-primary" onclick="guardarConfiguracionHorarios()">üíæ Guardar Horarios</button>
        </div>

        <div class="card">
          <h3>Estad√≠sticas del D√≠a</h3>
          <div id="estadisticasDia"></div>
        </div>

        <div class="card">
          <h3>Inscripciones al Comedor Hoy</h3>
          <div id="listaInscripcionesComedor"></div>
        </div>

        <div class="card">
          <h3>Notificaciones Enviadas a Tutores</h3>
          <div id="listaNotificaciones"></div>
        </div>

        <div class="card">
          <h3>Lista de Alumnos</h3>
          
          <!-- Filtros y b√∫squeda -->
          <div class="form-group">
            <input type="text" id="buscarAlumno" placeholder="Buscar por nombre o usuario..." onkeyup="filtrarAlumnos()">
          </div>
          
          <div class="button-group">
            <button class="btn-secondary" onclick="filtrarPorStrikes('todos')">Todos</button>
            <button class="btn-warning" onclick="filtrarPorStrikes('con-strikes')">Con Faltas</button>
            <button class="btn-success" onclick="filtrarPorStrikes('sin-strikes')">Sin Faltas</button>
            <button class="btn-primary" onclick="exportarAlumnosAExcel()">üì• Exportar a Excel</button>
          </div>
          
          <div id="listaAlumnos"></div>
        </div>

        <div class="card" style="border: 2px solid var(--danger);">
          <h3 style="color: var(--danger);">‚ö†Ô∏è Zona de Peligro</h3>
          <p style="color: #666; margin-bottom: 15px;">Acciones destructivas que no se pueden deshacer</p>
          <button class="btn-danger" onclick="depurarTodosAlumnos()" style="width: 100%;">
            üóëÔ∏è Eliminar TODOS los Alumnos
          </button>
          <small style="color: #666; display: block; margin-top: 10px;">
            Esta acci√≥n eliminar√° todos los alumnos de la base de datos. Se requiere doble confirmaci√≥n.
          </small>
        </div>

        <div class="button-group">
          <button class="btn-secondary" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>

      <!-- MEN√ö ALUMNO -->
      <div id="menuAlumno" class="oculto">
        <div class="card alumno-info">
          <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
            <img src="logo-colegio.png" alt="Logo CET N¬∞1" class="logo-menu" onerror="this.style.display='none'">
            <div style="flex: 1;">
              <h2 style="margin: 0;">üç¥ Mi Comedor</h2>
              <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">¬°Inscribite y disfrut√° del comedor!</p>
            </div>
          </div>
          
          <div class="alumno-detail">
            <strong>Nombre:</strong> <span id="alumnoNombre"></span>
          </div>
          <div class="alumno-detail">
            <strong>Curso y Divisi√≥n:</strong> <span id="alumnoCurso"></span>
          </div>
          
          <div id="strikesInfo" class="strikes-info oculto">
            <span class="strike-icon">‚ö†Ô∏è</span>
            <span id="strikesMessage"></span>
          </div>
          
          <div class="button-group" style="margin-top: 15px;">
            <button class="btn-primary" onclick="toggleModificarCuenta()" id="btnModificarCuenta">
              üîß Modificar Mi Cuenta
            </button>
          </div>
          
          <div id="formularioModificarCuenta" class="oculto" style="margin-top: 15px;">
            <h4>Modificar Usuario y Contrase√±a</h4>
            <div class="alert alert-warning" id="alertaModificacionCuenta">
              ‚ö†Ô∏è Solo podr√°s modificar tus credenciales UNA vez. Usa esta opci√≥n con cuidado.
            </div>
            <div class="form-group">
              <label for="nuevoUsuario">Nuevo Usuario:</label>
              <input type="text" id="nuevoUsuario" placeholder="Ingrese nuevo usuario">
            </div>
            <div class="form-group">
              <label for="nuevaContrase√±a">Nueva Contrase√±a:</label>
              <input type="password" id="nuevaContrase√±a" placeholder="Ingrese nueva contrase√±a">
            </div>
            <div class="form-group">
              <label for="confirmarContrase√±a">Confirmar Contrase√±a:</label>
              <input type="password" id="confirmarContrase√±a" placeholder="Confirme la nueva contrase√±a">
            </div>
            <div class="button-group">
              <button class="btn-success" onclick="guardarModificacionCuenta()">‚úì Guardar Cambios</button>
              <button class="btn-secondary" onclick="cancelarModificacionCuenta()">‚úï Cancelar</button>
            </div>
          </div>
        </div>

        <div class="card comedor-section">
          <h3>Comedor Escolar</h3>
          
          <div id="infoMenuAlumno" class="menu-del-dia oculto">
            <h4 id="tituloMenuAlumno">üçΩÔ∏è Men√∫:</h4>
            <p id="textoMenuAlumno"></p>
          </div>
          
          <div id="inscripcionComedor">
            <h4>üìÖ Inscribirse al comedor</h4>
            
            <div class="form-group">
              <label for="diaInscripcion">Seleccionar d√≠a:</label>
              <select id="diaInscripcion" onchange="cambiarDiaInscripcion()">
                <option value="hoy">Hoy</option>
                <option value="ma√±ana">Ma√±ana</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="horaComedor">Seleccionar horario:</label>
              <select id="horaComedor">
                <option value="12:00">12:00</option>
                <option value="12:30">12:30</option>
                <option value="13:00">13:00</option>
              </select>
            </div>
            <button class="btn-primary" onclick="inscribirComedor()">‚úì Confirmar Inscripci√≥n</button>
          </div>
          
          <div id="infoInscripcionComedor" class="oculto">
            <div class="alert alert-success">
              ‚úÖ Est√°s inscrito al comedor de <strong><span id="diaInscrito"></span></strong> a las <span id="horaInscrita"></span>
            </div>
            <div class="button-group" style="margin-top: 15px;">
              <button class="btn-warning" onclick="cancelarInscripcionComedor()">‚ùå Cancelar Inscripci√≥n</button>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-secondary" onclick="logout()">Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBqwPzVQYwVINq4svq-H2fuvyGigzoKafQ",
      authDomain: "comedor-cet1.firebaseapp.com",
      projectId: "comedor-cet1",
      storageBucket: "comedor-cet1.firebasestorage.app",
      messagingSenderId: "854464356769",
      appId: "1:854464356769:web:9f16f4137a229df162abe0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Hacer disponible globalmente
    window.db = db;
    window.firestore = { collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, onSnapshot, setDoc, getDoc };
  </script>
  <script src="script.js"></script>
</body>
</html>
